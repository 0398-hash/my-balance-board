<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Balance Board</title>

<!-- PWAè¨­å®š -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Balance Board">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#a78bfa">

<!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>âš–ï¸</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>âš–ï¸</text></svg>">

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #f3e8ff 50%, #fce7f3 100%); min-height: 100vh; padding: 20px; padding-bottom: 100px; }
.container { max-width: 900px; margin: 0 auto; }
.header { text-align: center; margin-bottom: 40px; position: relative; }
.header h1 { font-size: 36px; color: #374151; margin: 0; }
.header p { color: #6b7280; font-size: 14px; margin-top: 8px; }
.feedback-btn { position: absolute; top: 0; right: 0; padding: 10px 16px; background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 10px; font-size: 14px; font-weight: bold; color: #6b7280; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; }
.feedback-btn:hover { background: #e5e7eb; transform: scale(1.05); }
.nav-tabs { display: flex; gap: 10px; margin-bottom: 30px; background: white; padding: 10px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.nav-tab { flex: 1; padding: 12px; background: transparent; border: none; border-radius: 10px; font-weight: bold; font-size: 15px; cursor: pointer; color: #6b7280; transition: all 0.2s; }
.nav-tab.active { background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%); color: white; }
.nav-tab:hover:not(.active) { background: #f3f4f6; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: white; border-radius: 24px; padding: 40px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.card.editing { background: #fef3c7; border: 4px solid #fbbf24; }
.edit-banner { background: #fcd34d; border: 3px solid #f59e0b; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.edit-banner strong { color: #92400e; font-size: 16px; }
.edit-banner button { background: white; color: #f59e0b; border: 2px solid #f59e0b; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
.label { font-size: 18px; font-weight: bold; color: #374151; margin-bottom: 15px; display: block; }
input[type="date"], input[type="text"], textarea { width: 100%; padding: 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 12px; }
textarea { resize: none; font-family: sans-serif; }
.slider-container { margin: 40px 0; padding: 10px 0; }
.slider { width: 100%; height: 14px; border-radius: 7px; outline: none; -webkit-appearance: none; background: #d1d5db; cursor: default; pointer-events: none; }
.slider::-webkit-slider-track { height: 14px; border-radius: 7px; }
.slider::-webkit-slider-thumb { -webkit-appearance: none; width: 48px; height: 48px; background: white; border: 5px solid #86efac; border-radius: 50%; cursor: grab; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.15s ease; margin-top: -17px; pointer-events: auto; }
.slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
.slider::-webkit-slider-thumb:active { cursor: grabbing; transform: scale(1.15); }
.slider::-moz-range-track { height: 14px; border-radius: 7px; background: #d1d5db; border: none; }
.slider::-moz-range-thumb { width: 48px; height: 48px; background: white; border: 5px solid #86efac; border-radius: 50%; cursor: grab; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.slider.mental::-webkit-slider-thumb { border-color: #fca5a5; }
.slider.mental::-moz-range-thumb { border-color: #fca5a5; }
.btn { width: 100%; padding: 22px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 15px; transition: all 0.2s; }
.btn:hover { opacity: 0.9; transform: scale(1.02); }
.btn:active { transform: scale(0.98); }
.btn-primary { background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%); }
.btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); }
.btn-success { background: linear-gradient(135deg, #34d399 0%, #14b8a6 100%); }
.btn-info { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); }
.btn-cancel { background: #6b7280; }
.btn-small { padding: 8px 14px; font-size: 13px; display: inline-block; width: auto; margin: 0 4px; border-radius: 8px; }
.record { background: #f9fafb; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s; }
.record:hover { border-color: #a78bfa; }
.record.expanded { background: white; border-color: #a78bfa; }
.record-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.record-info { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.record-detail { margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb; display: none; }
.record.expanded .record-detail { display: block; }
.badge { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: bold; }
.badge-green { background: #d1fae5; color: #065f46; }
.badge-red { background: #fee2e2; color: #991b1b; }
.notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 16px 32px; border-radius: 12px; font-weight: bold; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
.notification.error { background: #ef4444; }
.notification.info { background: #3b82f6; }
.hidden { display: none; }
.period-selector { background: #f3e8ff; border: 2px solid #c084fc; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.period-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
.period-btn { padding: 10px 20px; border: 2px solid #a78bfa; background: white; color: #7c3aed; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; }
.period-btn.active { background: #a78bfa; color: white; }
.period-btn:hover { background: #e9d5ff; }
.preview-area { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-top: 15px; }
.preview-area textarea { background: white; font-family: monospace; font-size: 13px; }
.ai-input-area { background: #dbeafe; border: 2px solid #60a5fa; border-radius: 12px; padding: 20px; margin-top: 15px; }
#chartCanvas { width: 100%; height: 450px; background: white; border-radius: 12px; display: block; }
.data-management { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.data-management button { flex: 1; }
.floating-btn { position: fixed; bottom: 20px; right: 20px; width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); color: white; border: none; font-size: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); cursor: pointer; z-index: 100; transition: all 0.2s; }
.floating-btn:hover { transform: scale(1.1); }
.floating-btn:active { transform: scale(0.95); }
.profile-section { margin-bottom: 35px; }
.profile-section h3 { margin: 0 0 15px 0; font-size: 18px; color: #374151; display: flex; align-items: center; gap: 10px; }
.profile-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
.profile-item input { flex: 1; }
.profile-item button { padding: 12px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; min-width: 44px; }
.btn-add { background: #34d399; color: white; }
.btn-remove { background: #ef4444; color: white; }
.tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
.tag-button { padding: 8px 16px; background: #e9d5ff; color: #7c3aed; border: 2px solid #a78bfa; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
.tag-button:hover { background: #a78bfa; color: white; }
.tag-button:active { transform: scale(0.95); }
.tag-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.tag-item input { flex: 1; }
.profile-info-box { background: #eff6ff; border: 2px solid #60a5fa; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
.profile-info-box h4 { margin: 0 0 10px 0; color: #1e40af; font-size: 15px; }
.profile-info-box p { margin: 5px 0; font-size: 14px; color: #1e40af; }
.backup-section { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-top: 20px; }
.backup-section h3 { margin: 0 0 10px 0; font-size: 18px; color: #92400e; }
.backup-section p { margin: 0 0 15px 0; font-size: 13px; color: #92400e; }
.backup-info { background: white; border-radius: 8px; padding: 12px; margin: 10px 0; font-size: 13px; color: #374151; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.modal-content h2 { margin-top: 0; color: #374151; font-size: 24px; }
.modal-content h3 { color: #6b7280; font-size: 18px; margin-top: 25px; margin-bottom: 10px; }
.modal-content p { color: #374151; line-height: 1.8; margin: 10px 0; }
.modal-content ul { color: #374151; line-height: 1.8; padding-left: 25px; }
.modal-content .important { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; border-radius: 8px; }
.modal-close { background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
.modal-close:hover { background: #4b5563; }
@media (max-width: 600px) {
  .card { padding: 25px; }
  .header h1 { font-size: 28px; }
  .feedback-btn { position: static; display: block; margin: 15px auto 0; width: fit-content; }
  #chartCanvas { height: 400px; }
  .period-buttons { flex-direction: column; }
  .period-btn { width: 100%; }
  .floating-btn { bottom: 15px; right: 15px; width: 56px; height: 56px; font-size: 20px; }
  .data-management { grid-template-columns: 1fr; }
  .modal-content { padding: 25px; }
}
</style>
</head>
<body>

<div id="notification" class="notification hidden"></div>
<button id="floatingAIBtn" class="floating-btn hidden" onclick="scrollToAI()" title="AIåˆ†æ">ğŸ¤–</button>

<!-- åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="termsModal" class="modal" onclick="closeTermsModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h2>ğŸ“‹ åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …</h2>
    
    <h3>1. ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
    <p>My Balance Boardï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚¢ãƒ—ãƒªã€ï¼‰ã¯ã€æ—¥ã€…ã®ä½“èª¿ã‚’è¨˜éŒ²ã—ã€è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã®æ”¯æ´ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å°±åŠ´ç§»è¡Œæ”¯æ´ãªã©ã®ç¦ç¥‰ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…ãŒã€æ”¯æ´å“¡ã¨ã®é¢è«‡ã‚’ã‚ˆã‚Šå††æ»‘ã«ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
    
    <div class="important">
      <h3 style="margin-top:0;">âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h3>
      <ul style="margin-bottom:0;">
        <li><strong>æœ¬ã‚¢ãƒ—ãƒªã¯åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong></li>
        <li><strong>AIåˆ†æã¯åŒ»å­¦çš„è¨ºæ–­ã‚„æ²»ç™‚è¡Œç‚ºã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong></li>
        <li><strong>å¿…ãšä¸»æ²»åŒ»ã‚„å°‚é–€å®¶ã®æŒ‡ç¤ºã‚’å„ªå…ˆã—ã¦ãã ã•ã„</strong></li>
      </ul>
    </div>
    
    <h3>2. AIåˆ†ææ©Ÿèƒ½ã«ã¤ã„ã¦</h3>
    <p>æœ¬ã‚¢ãƒ—ãƒªã®AIåˆ†ææ©Ÿèƒ½ã¯ã€è¨˜éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‚¾å‘ã‚„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èª­ã¿å–ã‚Šã€å‚è€ƒæƒ…å ±ã¨ã—ã¦æç¤ºã™ã‚‹ã‚‚ã®ã§ã™ã€‚ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ï¼š</p>
    <ul>
      <li>AIåˆ†æã®çµæœã¯åŒ»å­¦çš„æ ¹æ‹ ã«åŸºã¥ãã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
      <li>è¨ºæ–­ã€æ²»ç™‚ã€æŠ•è–¬ã®åˆ¤æ–­ææ–™ã¨ã—ã¦ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„</li>
      <li>ä½“èª¿ã®æ€¥æ¿€ãªæ‚ªåŒ–ã‚„ç·Šæ€¥æ™‚ã¯ã€ç›´ã¡ã«åŒ»ç™‚æ©Ÿé–¢ã‚’å—è¨ºã—ã¦ãã ã•ã„</li>
      <li>æœè–¬ã®ä¸­æ–­ãƒ»å¤‰æ›´ã¯ã€å¿…ãšä¸»æ²»åŒ»ã«ç›¸è«‡ã—ã¦ãã ã•ã„</li>
    </ul>
    
    <h3>3. ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®è²¬ä»»</h3>
    <p>æœ¬ã‚¢ãƒ—ãƒªã§è¨˜éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š</p>
    <ul>
      <li><strong>ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»ç®¡ç†ã¯åˆ©ç”¨è€…ã®è‡ªå·±è²¬ä»»ã§ã™</strong></li>
      <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚„ãƒ‡ãƒã‚¤ã‚¹ã®æ•…éšœã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
      <li>å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™</li>
      <li>é–‹ç™ºè€…ã¯ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå¤±ãƒ»ç ´æã«ã¤ã„ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“</li>
      <li>ãƒ‡ãƒ¼ã‚¿ã®æ¼æ´©ã‚’é˜²ããŸã‚ã€å…±ç”¨ç«¯æœ«ã§ã®ä½¿ç”¨ã¯é¿ã‘ã¦ãã ã•ã„</li>
    </ul>
    
    <h3>4. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«ã¤ã„ã¦</h3>
    <ul>
      <li>æœ¬ã‚¢ãƒ—ãƒªã¯å€‹äººæƒ…å ±ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã›ã‚“</li>
      <li>ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹å†…ã«ä¿å­˜ã•ã‚Œã¾ã™</li>
      <li>æ„è¦‹ç®±ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰çµŒç”±ã§é€ä¿¡ã•ã‚ŒãŸæƒ…å ±ã¯ã€ã‚¢ãƒ—ãƒªæ”¹å–„ç›®çš„ã§ã®ã¿ä½¿ç”¨ã—ã¾ã™</li>
      <li>å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã®é€ä¿¡ã¯ä»»æ„ã§ã™</li>
    </ul>
    
    <h3>5. å…è²¬äº‹é …</h3>
    <ul>
      <li>æœ¬ã‚¢ãƒ—ãƒªã®ä½¿ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“</li>
      <li>æœ¬ã‚¢ãƒ—ãƒªã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
      <li>äºˆå‘Šãªãæ©Ÿèƒ½ã®å¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã¾ã™</li>
      <li>æœ¬ã‚¢ãƒ—ãƒªã®ä½¿ç”¨ã¯ã€åˆ©ç”¨è€…ã®è‡ªå·±è²¬ä»»ã«ãŠã„ã¦è¡Œã£ã¦ãã ã•ã„</li>
    </ul>
    
    <h3>6. æ¨å¥¨ã•ã‚Œã‚‹ä½¿ç”¨æ–¹æ³•</h3>
    <p>æœ¬ã‚¢ãƒ—ãƒªã‚’å®‰å…¨ã«ã”åˆ©ç”¨ã„ãŸã ããŸã‚ã«ã€ä»¥ä¸‹ã‚’æ¨å¥¨ã—ã¾ã™ï¼š</p>
    <ul>
      <li>ä¸»æ²»åŒ»ã‚„æ”¯æ´å“¡ã¨ç›¸è«‡ã®ä¸Šã§ä½¿ç”¨ã—ã¦ãã ã•ã„</li>
      <li>è¨˜éŒ²ã¯æ­£ç›´ã«ã€ã‚ã‚Šã®ã¾ã¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
      <li>AIåˆ†æã¯å‚è€ƒç¨‹åº¦ã«ã¨ã©ã‚ã€éåº¦ã«ä¾å­˜ã—ãªã„ã§ãã ã•ã„</li>
      <li>ä½“èª¿ã«ç•°å¤‰ã‚’æ„Ÿã˜ãŸã‚‰ã€ã™ãã«å°‚é–€å®¶ã«ç›¸è«‡ã—ã¦ãã ã•ã„</li>
      <li>é€±1å›ç¨‹åº¦ã€å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„</li>
    </ul>
    
    <div class="important">
      <p style="margin:0;"><strong>æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ä¸Šè¨˜ã®åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã—ã¾ã™ã€‚</strong></p>
    </div>
    
    <p style="margin-top:25px; color:#6b7280; font-size:14px;">æœ€çµ‚æ›´æ–°æ—¥ï¼š2025å¹´2æœˆ9æ—¥</p>
    
    <button class="modal-close" onclick="closeTermsModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1>My Balance Board</h1>
    <p>ã‚ãªãŸã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹ãˆã‚‹åŒ–</p>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLScz0mSrhhxfbLGkS7zFycRsr6MJlyGDEoLaPTX1z2PBicdWRw/viewform?usp=dialog" target="_blank" class="feedback-btn">ğŸ“® æ„è¦‹ç®±</a>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('record')">ğŸ“ è¨˜éŒ²</button>
    <button class="nav-tab" onclick="switchTab('profile')">ğŸ‘¤ è¨­å®š</button>
    <button class="nav-tab" onclick="switchTab('export')">ğŸ“¤ å…±æœ‰</button>
  </div>

  <!-- è¨˜éŒ²ã‚¿ãƒ– -->
  <div id="recordTab" class="tab-content active">
    <div id="inputCard" class="card">
      <div id="editBanner" class="edit-banner hidden">
        <div>
          <strong>âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</strong>
          <p style="margin:5px 0 0 0; font-size:13px; color:#92400e;" id="editingDateText"></p>
        </div>
        <button onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>

      <label class="label" id="dateLabel">ğŸ“… è¨˜éŒ²ã™ã‚‹æ—¥ä»˜</label>
      <input type="date" id="dateInput">

      <div class="slider-container">
        <label class="label">ğŸ§ ä½“ã®èª¿å­ <span id="physicalValue">5</span>/10</label>
        <input type="range" min="1" max="10" value="5" class="slider physical" id="physicalSlider">
      </div>

      <div class="slider-container">
        <label class="label">ğŸ’— å¿ƒã®èª¿å­ <span id="mentalValue">5</span>/10</label>
        <input type="range" min="1" max="10" value="5" class="slider mental" id="mentalSlider">
      </div>

      <label class="label">ğŸ“ ä»Šæ—¥ã®ãƒ¡ãƒ¢</label>
      <div id="tagButtons" class="tag-container"></div>
      <textarea id="memoInput" placeholder="æ°—ã«ãªã£ãŸã“ã¨ã€æ„Ÿã˜ãŸã“ã¨..." style="height:120px; margin-top:15px;"></textarea>

      <button class="btn btn-primary" id="saveBtn" onclick="saveRecord()">âœ“ è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <div id="chartCard" class="card hidden">
      <h2 style="margin-top:0; margin-bottom:10px; font-size:22px; color:#374151;">ğŸ“Š éå»7æ—¥é–“ã®æ¨ç§»</h2>
      <p style="color:#6b7280; font-size:14px; margin-bottom:20px;">ä½“ã¨å¿ƒã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¢ºèªã§ãã¾ã™</p>
      <canvas id="chartCanvas"></canvas>
    </div>

    <div id="recordsCard" class="card hidden">
      <h2 style="margin-top:0; margin-bottom:20px; font-size:22px; color:#374151;">ğŸ“‹ è¨˜éŒ²ä¸€è¦§</h2>
      <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">å„è¨˜éŒ²ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      <div id="recordsList"></div>
    </div>
  </div>

  <!-- è¨­å®šã‚¿ãƒ– -->
  <div id="profileTab" class="tab-content">
    <div class="card">
      <h2 style="margin-top:0; margin-bottom:10px; font-size:22px; color:#374151;">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
      <p style="color:#6b7280; font-size:14px; margin-bottom:30px;">AIåˆ†æã‚’ã‚ˆã‚Šçš„ç¢ºã«ã™ã‚‹ãŸã‚ã€ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

      <div class="profile-section">
        <h3>ğŸ¥ è¨ºæ–­å</h3>
        <div id="diagnosisList"></div>
      </div>

      <div class="profile-section">
        <h3>âœ¨ è‡ªåˆ†ã®ç‰¹æ€§ãƒ»å›°ã‚Šã”ã¨</h3>
        <textarea id="characteristicsInput" placeholder="ä¾‹ï¼šãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ãŒè‹¦æ‰‹ã€æ€¥ãªå¤‰æ›´ã«å¼±ã„ã€éŸ³ã«æ•æ„Ÿãªã©" style="height:100px;"></textarea>
      </div>

      <div class="profile-section">
        <h3>ğŸ’Š æœè–¬å†…å®¹</h3>
        <div id="medicationList"></div>
      </div>

      <div class="profile-section">
        <h3>ğŸ·ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°</h3>
        <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">è¨˜éŒ²æ™‚ã«ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å…¥åŠ›ã§ãã‚‹ã‚¿ã‚°ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
        <div id="customTagsList"></div>
      </div>

      <button class="btn btn-success" onclick="saveProfile()">âœ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜</button>

      <div class="backup-section">
        <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
        <p>å¤§åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹ãŸã‚ã€å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™</p>
        
        <div class="backup-info">
          <strong>ğŸ“Š ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼š</strong>
          <div id="backupInfo" style="margin-top:8px;"></div>
        </div>

        <div class="data-management">
          <button class="btn btn-info" onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
          <button class="btn btn-info" onclick="importData()">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</button>
        </div>
        
        <p style="margin-top:15px; font-size:12px; color:#92400e;">ğŸ’¡ ã‚¹ãƒãƒ›ã¨PCã§ãƒ‡ãƒ¼ã‚¿ã‚’ç§»å‹•ã™ã‚‹æ™‚ã‚‚ã€ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãã ã•ã„</p>
      </div>
    </div>
  </div>

  <!-- å…±æœ‰ã‚¿ãƒ– -->
  <div id="exportTab" class="tab-content">
    <div class="card" id="exportCard">
      <h2 style="margin-top:0; margin-bottom:20px; font-size:22px; color:#374151;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰</h2>
      
      <div id="profileInfoBox" class="profile-info-box hidden">
        <h4>ğŸ“‹ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒAIåˆ†æã«å«ã¾ã‚Œã¾ã™</h4>
        <p id="profileInfoText"></p>
      </div>

      <div class="period-selector">
        <h3 style="margin:0 0 5px 0; font-size:18px; color:#374151;">ğŸ“† å‡ºåŠ›æœŸé–“ã‚’é¸æŠ</h3>
        <p style="margin:0 0 10px 0; font-size:13px; color:#6b7280;">é¸æŠæœŸé–“: <strong id="periodCount">0æ—¥åˆ†</strong> <span id="periodType" style="color:#7c3aed; font-weight:bold;"></span></p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
          <div>
            <label style="font-size:13px; font-weight:bold; color:#374151; display:block; margin-bottom:5px;">é–‹å§‹æ—¥</label>
            <input type="date" id="startDate" onchange="updatePeriodCount()" style="padding:10px; font-size:14px;">
          </div>
          <div>
            <label style="font-size:13px; font-weight:bold; color:#374151; display:block; margin-bottom:5px;">çµ‚äº†æ—¥</label>
            <input type="date" id="endDate" onchange="updatePeriodCount()" style="padding:10px; font-size:14px;">
          </div>
        </div>
        <div class="period-buttons">
          <button class="period-btn" onclick="setPeriod(1)">ä»Šæ—¥ã®ã¿</button>
          <button class="period-btn" onclick="setPeriod(7)">ç›´è¿‘1é€±é–“</button>
          <button class="period-btn active" onclick="setPeriod(30)">ç›´è¿‘1ãƒ¶æœˆ</button>
          <button class="period-btn" onclick="setPeriod(90)">ç›´è¿‘3ãƒ¶æœˆ</button>
        </div>
      </div>

      <button class="btn btn-info" onclick="showAIPrompt()">ğŸ“‹ AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º</button>
      
      <div id="aiPromptPreview" class="preview-area hidden">
        <p style="margin:0 0 10px 0; font-size:14px; font-weight:bold; color:#92400e;">ğŸ’¡ ä»¥ä¸‹ã®å†…å®¹ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ï¼š</p>
        <textarea id="aiPromptText" readonly style="height:300px;" onclick="this.select()"></textarea>
        <button class="btn btn-info" onclick="copyAIPrompt()">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
      </div>

      <div class="ai-input-area">
        <h3 style="margin:0 0 10px 0; font-size:18px; color:#1e40af;">ğŸ¤– AIåˆ†æçµæœã‚’è²¼ã‚Šä»˜ã‘</h3>
        <p style="margin:0 0 10px 0; font-size:13px; color:#1e40af;">ä¸Šã®ã€ŒAIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã§Claudeã«åˆ†æã—ã¦ã‚‚ã‚‰ã£ãŸçµæœã‚’ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã«è‡ªå‹•ã§å«ã¾ã‚Œã¾ã™ã€‚</p>
        <textarea id="aiResultInput" placeholder="Claudeã®åˆ†æçµæœã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." style="height:150px;"></textarea>
        <p id="aiResultStatus" style="margin:10px 0 0 0; font-size:13px; font-weight:bold; color:#1e40af;" class="hidden">âœ“ AIåˆ†æçµæœãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™</p>
      </div>

      <button class="btn btn-success" onclick="generateEmail()">ğŸ“¨ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ</button>

      <div id="emailPreview" class="preview-area hidden" style="background:#d1fae5; border-color:#34d399;">
        <p style="margin:0 0 10px 0; font-size:14px; font-weight:bold; color:#065f46;">ğŸ“§ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼š</p>
        <textarea id="emailText" readonly style="height:300px;" onclick="this.select()"></textarea>
        <button class="btn btn-success" onclick="copyEmail()">ğŸ“‹ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <div class="card" style="text-align:center; padding:20px; background:transparent; box-shadow:none;">
    <p style="color:#9ca3af; font-size:13px;">ğŸ”’ ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ã‚ãªãŸã®ãƒ‡ãƒã‚¤ã‚¹ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
    <p style="color:#9ca3af; font-size:12px; margin-top:8px;">
      v1.0.0 | 
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScz0mSrhhxfbLGkS7zFycRsr6MJlyGDEoLaPTX1z2PBicdWRw/viewform?usp=dialog" target="_blank" style="color:#9ca3af;">æ„è¦‹ç®±</a> | 
      <a href="javascript:void(0)" onclick="openTermsModal()" style="color:#9ca3af;">åˆ©ç”¨è¦ç´„</a>
    </p>
  </div>
</div>

<script>
let records = [];
let profile = { 
  diagnoses: [''],
  characteristics: '', 
  medications: [''],
  customTags: []
};
let isEditing = false;
let editingDate = null;
let sliderDragging = { physical: false, mental: false };
let currentTab = 'record';

function openTermsModal() {
  document.getElementById('termsModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeTermsModal(event) {
  if (!event || event.target.id === 'termsModal') {
    document.getElementById('termsModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  }
}

function init() {
  const saved = localStorage.getItem('balanceRecords');
  if (saved) records = JSON.parse(saved);
  
  const savedProfile = localStorage.getItem('balanceProfile');
  if (savedProfile) {
    const loaded = JSON.parse(savedProfile);
    profile = {
      diagnoses: loaded.diagnoses || (loaded.diagnosis ? [loaded.diagnosis] : ['']),
      characteristics: loaded.characteristics || '',
      medications: loaded.medications || (loaded.medication ? [loaded.medication] : ['']),
      customTags: loaded.customTags || []
    };
  }
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').value = today;
  document.getElementById('dateInput').max = today;
  
  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
  document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
  document.getElementById('endDate').value = today;
  document.getElementById('endDate').max = today;
  
  setupSlider('physical');
  setupSlider('mental');
  
  document.getElementById('aiResultInput').oninput = function() {
    document.getElementById('aiResultStatus').classList.toggle('hidden', !this.value.trim());
  };
  
  document.getElementById('characteristicsInput').value = profile.characteristics;
  
  renderDiagnosisList();
  renderMedicationList();
  renderCustomTagsList();
  renderTagButtons();
  updateBackupInfo();
  updatePeriodCount();
  updateDisplay();
  updateProfileInfo();
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  
  if (tab === 'record') {
    document.querySelectorAll('.nav-tab')[0].classList.add('active');
    document.getElementById('recordTab').classList.add('active');
  } else if (tab === 'profile') {
    document.querySelectorAll('.nav-tab')[1].classList.add('active');
    document.getElementById('profileTab').classList.add('active');
    updateBackupInfo();
  } else if (tab === 'export') {
    document.querySelectorAll('.nav-tab')[2].classList.add('active');
    document.getElementById('exportTab').classList.add('active');
  }
  
  updateFloatingButton();
}

function updateBackupInfo() {
  const info = document.getElementById('backupInfo');
  const recordCount = records.length;
  const diagnoses = profile.diagnoses.filter(d => d.trim()).length;
  const medications = profile.medications.filter(m => m.trim()).length;
  const tags = profile.customTags.filter(t => t.trim()).length;
  
  let html = `<div style="color:#374151;">`;
  html += `â€¢ ä½“èª¿è¨˜éŒ²ï¼š<strong>${recordCount}ä»¶</strong><br>`;
  html += `â€¢ è¨ºæ–­åï¼š<strong>${diagnoses}ä»¶</strong><br>`;
  html += `â€¢ æœè–¬æƒ…å ±ï¼š<strong>${medications}ä»¶</strong><br>`;
  html += `â€¢ ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ï¼š<strong>${tags}ä»¶</strong><br>`;
  if (profile.characteristics) html += `â€¢ ç‰¹æ€§ï¼š<strong>ç™»éŒ²æ¸ˆã¿</strong><br>`;
  html += `</div>`;
  
  info.innerHTML = html;
}

function updateFloatingButton() {
  const btn = document.getElementById('floatingAIBtn');
  if (currentTab === 'record' && records.length > 0) {
    btn.classList.remove('hidden');
  } else {
    btn.classList.add('hidden');
  }
}

function scrollToAI() {
  switchTab('export');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function setupSlider(type) {
  const slider = document.getElementById(`${type}Slider`);
  const valueSpan = document.getElementById(`${type}Value`);
  
  let isDraggingThumb = false;
  
  slider.addEventListener('mousedown', function(e) {
    const thumb = e.target;
    if (thumb === slider) {
      const rect = slider.getBoundingClientRect();
      const thumbWidth = 48;
      const mouseX = e.clientX - rect.left;
      const value = parseInt(slider.value);
      const valuePercent = (value - 1) / 9;
      const thumbCenter = rect.width * valuePercent;
      
      if (Math.abs(mouseX - thumbCenter) <= thumbWidth / 2) {
        isDraggingThumb = true;
      }
    }
  });
  
  slider.addEventListener('touchstart', function(e) {
    const rect = slider.getBoundingClientRect();
    const touch = e.touches[0];
    const thumbWidth = 48;
    const touchX = touch.clientX - rect.left;
    const value = parseInt(slider.value);
    const valuePercent = (value - 1) / 9;
    const thumbCenter = rect.width * valuePercent;
    
    if (Math.abs(touchX - thumbCenter) <= thumbWidth / 2) {
      isDraggingThumb = true;
    }
  });
  
  slider.addEventListener('input', function() {
    if (isDraggingThumb) {
      valueSpan.textContent = this.value;
      updateSliderBackground(this, type);
    } else {
      this.value = valueSpan.textContent;
    }
  });
  
  slider.addEventListener('mouseup', function() {
    isDraggingThumb = false;
  });
  
  slider.addEventListener('touchend', function() {
    isDraggingThumb = false;
  });
  
  document.addEventListener('mouseup', function() {
    isDraggingThumb = false;
  });
  
  updateSliderBackground(slider, type);
}

function updateSliderBackground(slider, type) {
  const value = slider.value;
  const percent = ((value - 1) / 9) * 100;
  const color = type === 'physical' ? '#86efac' : '#fca5a5';
  slider.style.background = `linear-gradient(90deg, ${color} ${percent}%, #d1d5db ${percent}%)`;
}

function renderDiagnosisList() {
  const container = document.getElementById('diagnosisList');
  container.innerHTML = '';
  
  profile.diagnoses.forEach((diagnosis, index) => {
    const item = document.createElement('div');
    item.className = 'profile-item';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = diagnosis;
    input.placeholder = 'ä¾‹ï¼šADHDã€ASDã€çŸ¥çš„éšœå®³ãªã©';
    input.oninput = function() {
      profile.diagnoses[index] = this.value;
    };
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add';
    addBtn.textContent = '+';
    addBtn.onclick = function() {
      profile.diagnoses.splice(index + 1, 0, '');
      renderDiagnosisList();
    };
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn-remove';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = function() {
      if (profile.diagnoses.length > 1) {
        profile.diagnoses.splice(index, 1);
        renderDiagnosisList();
      }
    };
    
    item.appendChild(input);
    item.appendChild(addBtn);
    if (profile.diagnoses.length > 1) {
      item.appendChild(removeBtn);
    }
    
    container.appendChild(item);
  });
}

function renderMedicationList() {
  const container = document.getElementById('medicationList');
  container.innerHTML = '';
  
  profile.medications.forEach((medication, index) => {
    const item = document.createElement('div');
    item.className = 'profile-item';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = medication;
    input.placeholder = 'ä¾‹ï¼šâ—‹â—‹ï¼ˆæœ1éŒ ã€å¤œ1éŒ ï¼‰';
    input.oninput = function() {
      profile.medications[index] = this.value;
    };
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add';
    addBtn.textContent = '+';
    addBtn.onclick = function() {
      profile.medications.splice(index + 1, 0, '');
      renderMedicationList();
    };
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn-remove';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = function() {
      if (profile.medications.length > 1) {
        profile.medications.splice(index, 1);
        renderMedicationList();
      }
    };
    
    item.appendChild(input);
    item.appendChild(addBtn);
    if (profile.medications.length > 1) {
      item.appendChild(removeBtn);
    }
    
    container.appendChild(item);
  });
}

function renderCustomTagsList() {
  const container = document.getElementById('customTagsList');
  container.innerHTML = '';
  
  if (profile.customTags.length === 0) {
    profile.customTags.push('');
  }
  
  profile.customTags.forEach((tag, index) => {
    const item = document.createElement('div');
    item.className = 'tag-item';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = tag;
    input.placeholder = 'ä¾‹ï¼š#åèŠ»ã‚ã‚Šã€#ä»•äº‹ã€#ASMRãªã©';
    input.oninput = function() {
      profile.customTags[index] = this.value;
      renderTagButtons();
    };
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add';
    addBtn.textContent = '+';
    addBtn.onclick = function() {
      profile.customTags.splice(index + 1, 0, '');
      renderCustomTagsList();
    };
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn-remove';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = function() {
      if (profile.customTags.length > 1) {
        profile.customTags.splice(index, 1);
        renderCustomTagsList();
        renderTagButtons();
      }
    };
    
    item.appendChild(input);
    item.appendChild(addBtn);
    if (profile.customTags.length > 1) {
      item.appendChild(removeBtn);
    }
    
    container.appendChild(item);
  });
}

function renderTagButtons() {
  const container = document.getElementById('tagButtons');
  container.innerHTML = '';
  
  const activeTags = profile.customTags.filter(t => t.trim());
  
  if (activeTags.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  
  activeTags.forEach(tag => {
    const btn = document.createElement('button');
    btn.className = 'tag-button';
    btn.textContent = tag;
    btn.onclick = function() {
      const memoInput = document.getElementById('memoInput');
      const currentValue = memoInput.value;
      memoInput.value = currentValue ? `${currentValue} ${tag}` : tag;
    };
    container.appendChild(btn);
  });
}

function saveProfile() {
  profile.characteristics = document.getElementById('characteristicsInput').value.trim();
  profile.diagnoses = profile.diagnoses.filter(d => d.trim());
  profile.medications = profile.medications.filter(m => m.trim());
  profile.customTags = profile.customTags.filter(t => t.trim());
  
  if (profile.diagnoses.length === 0) profile.diagnoses = [''];
  if (profile.medications.length === 0) profile.medications = [''];
  
  localStorage.setItem('balanceProfile', JSON.stringify(profile));
  showNotification('âœ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
  updateProfileInfo();
  updateBackupInfo();
  renderTagButtons();
}

function updateProfileInfo() {
  const diagnoses = profile.diagnoses.filter(d => d.trim());
  const medications = profile.medications.filter(m => m.trim());
  const hasProfile = diagnoses.length > 0 || profile.characteristics || medications.length > 0;
  const box = document.getElementById('profileInfoBox');
  
  if (hasProfile) {
    let info = [];
    if (diagnoses.length > 0) info.push(`è¨ºæ–­: ${diagnoses.join('ã€')}`);
    if (profile.characteristics) info.push(`ç‰¹æ€§: ${profile.characteristics}`);
    if (medications.length > 0) info.push(`æœè–¬: ${medications.join('ã€')}`);
    
    document.getElementById('profileInfoText').textContent = info.join(' / ');
    box.classList.remove('hidden');
  } else {
    box.classList.add('hidden');
  }
}

function saveRecord() {
  const date = document.getElementById('dateInput').value;
  const physical = parseInt(document.getElementById('physicalSlider').value);
  const mental = parseInt(document.getElementById('mentalSlider').value);
  const memo = document.getElementById('memoInput').value.trim();
  
  if (isEditing && editingDate !== date) {
    records = records.filter(r => r.date !== editingDate && r.date !== date);
  } else {
    records = records.filter(r => r.date !== date);
  }
  
  records.push({ date, physical, mental, memo });
  records.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  localStorage.setItem('balanceRecords', JSON.stringify(records));
  showNotification(isEditing ? 'è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'è¨˜éŒ²ã—ã¾ã—ãŸï¼');
  
  isEditing = false;
  editingDate = null;
  resetForm();
  updateDisplay();
}

function editRecord(date) {
  const record = records.find(r => r.date === date);
  if (!record) return;
  
  isEditing = true;
  editingDate = date;
  
  switchTab('record');
  
  setTimeout(() => {
    document.getElementById('dateInput').value = record.date;
    document.getElementById('physicalSlider').value = record.physical;
    document.getElementById('mentalSlider').value = record.mental;
    document.getElementById('memoInput').value = record.memo;
    document.getElementById('physicalValue').textContent = record.physical;
    document.getElementById('mentalValue').textContent = record.mental;
    
    updateSliderBackground(document.getElementById('physicalSlider'), 'physical');
    updateSliderBackground(document.getElementById('mentalSlider'), 'mental');
    
    document.getElementById('inputCard').classList.add('editing');
    document.getElementById('editBanner').classList.remove('hidden');
    document.getElementById('editingDateText').textContent = `${date}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ä¸­ã§ã™`;
    document.getElementById('dateLabel').textContent = 'ğŸ“… å¤‰æ›´å¾Œã®æ—¥ä»˜';
    document.getElementById('saveBtn').textContent = 'âœ“ æ›´æ–°ã™ã‚‹';
    document.getElementById('saveBtn').className = 'btn btn-warning';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 100);
  
  showNotification(`${date}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ä¸­`, 'info');
}

function cancelEdit() {
  isEditing = false;
  editingDate = null;
  resetForm();
  showNotification('ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'info');
}

function resetForm() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').value = today;
  document.getElementById('physicalSlider').value = 5;
  document.getElementById('mentalSlider').value = 5;
  document.getElementById('memoInput').value = '';
  document.getElementById('physicalValue').textContent = '5';
  document.getElementById('mentalValue').textContent = '5';
  
  updateSliderBackground(document.getElementById('physicalSlider'), 'physical');
  updateSliderBackground(document.getElementById('mentalSlider'), 'mental');
  
  document.getElementById('inputCard').classList.remove('editing');
  document.getElementById('editBanner').classList.add('hidden');
  document.getElementById('dateLabel').textContent = 'ğŸ“… è¨˜éŒ²ã™ã‚‹æ—¥ä»˜';
  document.getElementById('saveBtn').textContent = 'âœ“ è¨˜éŒ²ã™ã‚‹';
  document.getElementById('saveBtn').className = 'btn btn-primary';
}

function toggleRecord(index) {
  const record = document.getElementById(`record-${index}`);
  record.classList.toggle('expanded');
}

function updateDisplay() {
  const hasRecords = records.length > 0;
  document.getElementById('chartCard').classList.toggle('hidden', !hasRecords);
  document.getElementById('recordsCard').classList.toggle('hidden', !hasRecords);
  
  if (hasRecords) {
    drawChart();
    displayRecords();
    updatePeriodCount();
  }
  
  updateFloatingButton();
}

function drawChart() {
  const canvas = document.getElementById('chartCanvas');
  const ctx = canvas.getContext('2d');
  
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * dpr;
  canvas.height = 450 * dpr;
  ctx.scale(dpr, dpr);
  
  const sorted = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
  const last7 = sorted.slice(0, 7).reverse();
  
  if (last7.length === 0) return;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  const padding = 60;
  const bottomPadding = 70;
  const chartWidth = canvas.offsetWidth - padding * 2;
  const chartHeight = 450 - padding - bottomPadding;
  const barSpacing = chartWidth / (last7.length * 2.5 + 1);
  const barWidth = barSpacing * 0.9;
  const cornerRadius = 8;
  
  ctx.strokeStyle = '#e5e7eb';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 10; i += 2) {
    const y = padding + chartHeight - (i / 10 * chartHeight);
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(canvas.offsetWidth - padding, y);
    ctx.stroke();
  }
  
  ctx.fillStyle = '#6b7280';
  ctx.font = 'bold 14px sans-serif';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 10; i += 2) {
    const y = padding + chartHeight - (i / 10 * chartHeight);
    ctx.fillText(i, padding - 15, y + 5);
  }
  
  ctx.strokeStyle = '#9ca3af';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(padding, padding + chartHeight);
  ctx.lineTo(canvas.offsetWidth - padding, padding + chartHeight);
  ctx.stroke();
  
  function drawRoundedBar(x, y, width, height, radius, color) {
    if (height < radius) radius = height;
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height);
    ctx.lineTo(x, y + height);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
    ctx.fill();
  }
  
  last7.forEach((record, index) => {
    const x = padding + (index * 2.5 + 0.5) * barSpacing;
    const centerX = x + barWidth + 2.5;
    
    const physicalHeight = (record.physical / 10) * chartHeight;
    drawRoundedBar(x, padding + chartHeight - physicalHeight, barWidth, physicalHeight, cornerRadius, '#86efac');
    
    const mentalHeight = (record.mental / 10) * chartHeight;
    drawRoundedBar(x + barWidth + 5, padding + chartHeight - mentalHeight, barWidth, mentalHeight, cornerRadius, '#fca5a5');
    
    const date = new Date(record.date);
    const label = `${date.getMonth() + 1}/${date.getDate()}`;
    ctx.fillStyle = '#374151';
    ctx.font = 'bold 13px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(label, centerX, padding + chartHeight + 30);
  });
  
  ctx.fillStyle = '#86efac';
  ctx.fillRect(padding, 15, 25, 25);
  ctx.fillStyle = '#374151';
  ctx.font = 'bold 16px sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('ä½“', padding + 35, 33);
  
  ctx.fillStyle = '#fca5a5';
  ctx.fillRect(padding + 100, 15, 25, 25);
  ctx.fillStyle = '#374151';
  ctx.fillText('å¿ƒ', padding + 135, 33);
}

function displayRecords() {
  const sorted = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
  let html = '';
  sorted.forEach((r, i) => {
    html += `<div class="record" id="record-${i}" onclick="toggleRecord(${i})">
      <div class="record-header">
        <div class="record-info">
          <strong style="font-size:15px;">${r.date}</strong>
          <span class="badge badge-green">ä½“ ${r.physical}</span>
          <span class="badge badge-red">å¿ƒ ${r.mental}</span>
        </div>
      </div>
      <div class="record-detail">
        ${r.memo ? `<p style="margin:0 0 15px 0; color:#374151; line-height:1.6;"><strong>ãƒ¡ãƒ¢:</strong> ${r.memo}</p>` : '<p style="margin:0 0 15px 0; color:#9ca3af;">ãƒ¡ãƒ¢ãªã—</p>'}
        <button class="btn btn-info btn-small" onclick="event.stopPropagation(); editRecord('${r.date}')">âœï¸ ç·¨é›†</button>
      </div>
    </div>`;
  });
  document.getElementById('recordsList').innerHTML = html;
}

function setPeriod(days) {
  const end = new Date();
  const start = new Date();
  
  if (days === 1) {
    start.setDate(end.getDate());
  } else {
    start.setDate(start.getDate() - days + 1);
  }
  
  document.getElementById('startDate').value = start.toISOString().split('T')[0];
  document.getElementById('endDate').value = end.toISOString().split('T')[0];
  
  document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  updatePeriodCount();
}

function updatePeriodCount() {
  const filtered = getFilteredRecords();
  const days = filtered.length;
  document.getElementById('periodCount').textContent = `${days}æ—¥åˆ†`;
  
  let periodType = '';
  if (days === 1) periodType = 'ï¼ˆä»Šæ—¥ã®è©³ç´°åˆ†æï¼‰';
  else if (days >= 2 && days <= 7) periodType = 'ï¼ˆé€±ã®ãƒªã‚ºãƒ åˆ†æï¼‰';
  else if (days >= 8 && days <= 31) periodType = 'ï¼ˆæœˆæ¬¡ãƒã‚¤ã‚ªãƒªã‚ºãƒ ï¼‰';
  else if (days > 31) periodType = 'ï¼ˆé•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼‰';
  
  document.getElementById('periodType').textContent = periodType;
}

function getFilteredRecords() {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  return records.filter(r => r.date >= start && r.date <= end).sort((a, b) => new Date(a.date) - new Date(b.date));
}

function showAIPrompt() {
  const filtered = getFilteredRecords();
  if (filtered.length === 0) {
    showNotification('æŒ‡å®šæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const days = filtered.length;
  const dataText = filtered.map(r => `æ—¥ä»˜: ${r.date}\nä½“ã®èª¿å­: ${r.physical}/10\nå¿ƒã®èª¿å­: ${r.mental}/10\nãƒ¡ãƒ¢: ${r.memo || 'ãªã—'}\n`).join('\n');
  
  let profileSection = '';
  const diagnoses = profile.diagnoses.filter(d => d.trim());
  const medications = profile.medications.filter(m => m.trim());
  
  if (diagnoses.length > 0 || profile.characteristics || medications.length > 0) {
    profileSection = 'ã€ç§ã®èƒŒæ™¯æƒ…å ±ã€‘\n';
    if (diagnoses.length > 0) profileSection += `è¨ºæ–­å: ${diagnoses.join('ã€')}\n`;
    if (profile.characteristics) profileSection += `ç‰¹æ€§ãƒ»å›°ã‚Šã”ã¨: ${profile.characteristics}\n`;
    if (medications.length > 0) profileSection += `æœè–¬å†…å®¹: ${medications.join('ã€')}\n`;
    profileSection += '\n';
  }
  
  let analysisInstruction = '';
  if (days === 1) {
    analysisInstruction = `ã€ä»Šæ—¥ã®è©³ç´°åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‘
- ä½“ã¨å¿ƒã®æ•°å€¤ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ä»Šæ—¥ã®çŠ¶æ…‹
- ãƒ¡ãƒ¢ã®å†…å®¹ã‹ã‚‰æ¨æ¸¬ã•ã‚Œã‚‹å…·ä½“çš„ãªå‡ºæ¥äº‹ã‚„è¦å› 
- æ˜æ—¥ä»¥é™ã«æ´»ã‹ã›ã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹`;
  } else if (days >= 2 && days <= 7) {
    analysisInstruction = `ã€é€±ã®ãƒªã‚ºãƒ åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‘
- é€±ã®ä¸­ã§ã®ä½“èª¿ã®æ³¢ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
- æ›œæ—¥ã‚„æ™‚æœŸã«ã‚ˆã‚‹å‚¾å‘
- é€±å˜ä½ã§æ„è­˜ã™ã¹ãç”Ÿæ´»ãƒªã‚ºãƒ ã®æ”¹å–„ç‚¹`;
  } else if (days >= 8 && days <= 31) {
    analysisInstruction = `ã€æœˆæ¬¡ãƒã‚¤ã‚ªãƒªã‚ºãƒ åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‘
- 1ãƒ¶æœˆã‚’é€šã˜ãŸä½“ã¨å¿ƒã®ãƒãƒ©ãƒ³ã‚¹ã®å¤‰åŒ–
- è‰¯ã„æœŸé–“ã¨è‹¦ã—ã„æœŸé–“ã®ç‰¹å¾´
- æœˆå˜ä½ã§èª¿æ•´ã™ã¹ãç”Ÿæ´»ç¿’æ…£ã‚„ç’°å¢ƒè¦å› `;
  } else {
    analysisInstruction = `ã€é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‘
- é•·æœŸçš„ãªä½“èª¿ã®æ¨ç§»ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³
- ç’°å¢ƒã‚„å­£ç¯€ã«ã‚ˆã‚‹å½±éŸ¿ã®å¯èƒ½æ€§
- ä»Šå¾Œã®ç”Ÿæ´»è¨­è¨ˆã«å‘ã‘ãŸä¸­é•·æœŸçš„ãªæè¨€`;
  }
  
  const prompt = `ç§ã¯è‡ªåˆ†ã®çŠ¶æ…‹ã‚’èª¬æ˜ã™ã‚‹ã®ãŒè‹¦æ‰‹ã§ã™ã€‚${profileSection ? 'ä»¥ä¸‹ã®èƒŒæ™¯æƒ…å ±ã‚’è¸ã¾ãˆãŸä¸Šã§ã€' : ''}${start}ã€œ${end}ã®è¨˜éŒ²ï¼ˆ${days}æ—¥åˆ†ï¼‰ã‚’è©³ç´°ã«åˆ†æã—ã€2ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†ã‘ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚

${profileSection}${analysisInstruction}

ã€å›ç­”ã®æ§‹æˆã€‘

**ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ç§ã¸ã®å¯„ã‚Šæ·»ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**
å„ªã—ã„å£èª¿ã§ã€ç§ã«å‘ã‘ã¦ä»¥ä¸‹ã‚’ä¼ãˆã¦ãã ã•ã„ï¼š
- ã“ã®æœŸé–“ã®é ‘å¼µã‚Šã‚„å¤‰åŒ–ã¸ã®åŠ´ã„ã®è¨€è‘‰
- æ°—ã¥ã„ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„å‚¾å‘ã«ã¤ã„ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ä»Šå¾Œæ°—ã‚’ã¤ã‘ã‚‹ã¨ã‚ˆã„ã“ã¨

**ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: æ”¯æ´å“¡ã•ã‚“ã¸ã®å…±æœ‰ç”¨ï¼ˆå¿…ãšä»¥ä¸‹ã®å½¢å¼ã§ï¼‰**

â–¼ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼â–¼

ã€æœŸé–“ã€‘
${start} ã€œ ${end}ï¼ˆ${days}æ—¥åˆ†ï¼‰

ã€ãƒãƒ©ãƒ³ã‚¹åˆ†æã€‘
ä½“ã¨å¿ƒã®æ•°å€¤ã®ä¹–é›¢ã€ãƒãƒ©ãƒ³ã‚¹ã®çŠ¶æ…‹ã«ã¤ã„ã¦

ã€å¤‰åŒ–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
æ•°å€¤ã®æ¨ç§»ã‹ã‚‰è¦‹ãˆã‚‹å‚¾å‘ã€æ³¢ã®ç‰¹å¾´

ã€æ³¨æ„ã™ã¹ãç‚¹ã€‘
ä»Šå¾Œã®ãƒªã‚¹ã‚¯ã‚„æ°—ã‚’ã¤ã‘ã‚‹ã¹ãã“ã¨

ã€æ”¯æ´å“¡ã•ã‚“ã¸ã€‘
é¢è«‡ã§ç¢ºèªã—ã¦ã»ã—ã„ãƒã‚¤ãƒ³ãƒˆã€ã‚µãƒãƒ¼ãƒˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹

â–²ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼â–²

â€»ã€Œâ–¼ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼â–¼ã€ã¨ã€Œâ–²ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼â–²ã€ã®ç›®å°ã¯å¿…ãšå…¥ã‚Œã¦ãã ã•ã„ã€‚ã“ã®é–“ã®å†…å®¹ã‚’ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ï¼š
${dataText}`;
  
  document.getElementById('aiPromptText').value = prompt;
  document.getElementById('aiPromptPreview').classList.remove('hidden');
}

function copyAIPrompt() {
  const text = document.getElementById('aiPromptText').value;
  navigator.clipboard.writeText(text).then(() => {
    showNotification('âœ“ AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }).catch(() => {
    showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
  });
}

function generateEmail() {
  const filtered = getFilteredRecords();
  if (filtered.length === 0) {
    showNotification('æŒ‡å®šæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const aiResult = document.getElementById('aiResultInput').value.trim();
  const dataText = filtered.map(r => `æ—¥ä»˜: ${r.date}\nä½“ã®èª¿å­: ${r.physical}/10\nå¿ƒã®èª¿å­: ${r.mental}/10\nãƒ¡ãƒ¢: ${r.memo || 'ãªã—'}\n`).join('\n');
  
  const aiSection = aiResult ? `
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€AIã«ã‚ˆã‚‹åˆ†æçµæœã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${aiResult}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

` : '';
  
  const email = `ä»¶å: ç§ã®ä½“èª¿ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ${start} ã€œ ${end}ï¼‰

æœ¬æ–‡:

æ”¯æ´å“¡æ§˜

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ç§ã®ä½“èª¿è¨˜éŒ²ï¼ˆä½“ã¨å¿ƒã®10æ®µéšè©•ä¾¡ï¼‰ã‚’é€ä»˜ã—ã¾ã™ã€‚é¢è«‡ã®éš›ã®å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚

${aiSection}ã€æœŸé–“ã€‘
${start} ã€œ ${end}ï¼ˆå…¨${filtered.length}æ—¥åˆ†ï¼‰

ã€è©³ç´°ãƒ‡ãƒ¼ã‚¿ã€‘

${dataText}

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
  
  document.getElementById('emailText').value = email;
  document.getElementById('emailPreview').classList.remove('hidden');
}

function copyEmail() {
  const text = document.getElementById('emailText').value;
  navigator.clipboard.writeText(text).then(() => {
    showNotification('âœ“ ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }).catch(() => {
    showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
  });
}

function exportData() {
  if (records.length === 0 && !profile.characteristics && profile.diagnoses.filter(d => d.trim()).length === 0) {
    showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  const exportData = {
    version: '1.0.0',
    exportDate: new Date().toISOString(),
    records: records,
    profile: profile
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `balance-board-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification(`âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const imported = JSON.parse(event.target.result);
        
        let recordsToImport = [];
        let profileToImport = { diagnoses: [''], characteristics: '', medications: [''], customTags: [] };
        
        if (imported.records && Array.isArray(imported.records)) {
          recordsToImport = imported.records;
          if (imported.profile) {
            const p = imported.profile;
            profileToImport = {
              diagnoses: p.diagnoses || (p.diagnosis ? [p.diagnosis] : ['']),
              characteristics: p.characteristics || '',
              medications: p.medications || (p.medication ? [p.medication] : ['']),
              customTags: p.customTags || []
            };
          }
        } else if (Array.isArray(imported)) {
          recordsToImport = imported;
        } else {
          throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼');
        }
        
        const confirmMsg = `${recordsToImport.length}ä»¶ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™`;
        const confirm = window.confirm(confirmMsg);
        if (!confirm) return;
        
        records = recordsToImport;
        profile = profileToImport;
        
        localStorage.setItem('balanceRecords', JSON.stringify(records));
        localStorage.setItem('balanceProfile', JSON.stringify(profile));
        
        document.getElementById('characteristicsInput').value = profile.characteristics;
        
        renderDiagnosisList();
        renderMedicationList();
        renderCustomTagsList();
        renderTagButtons();
        updateDisplay();
        updateProfileInfo();
        updateBackupInfo();
        showNotification(`âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰${recordsToImport.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼`);
      } catch (error) {
        showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        console.error(error);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function showNotification(msg, type = 'success') {
  const notif = document.getElementById('notification');
  notif.textContent = msg;
  notif.className = 'notification';
  if (type === 'error') notif.classList.add('error');
  if (type === 'info') notif.classList.add('info');
  setTimeout(() => notif.classList.add('hidden'), 3000);
}

window.addEventListener('resize', () => {
  if (records.length > 0) drawChart();
});

init();
</script>

</body>
</html>